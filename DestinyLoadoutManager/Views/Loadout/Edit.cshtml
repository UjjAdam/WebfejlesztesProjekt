@model DestinyLoadoutManager.Models.Loadout

@{
    ViewData["Title"] = $"Edit - {Model.Name}";
    var primaryWeapons = ViewBag.PrimaryWeapons as List<DestinyLoadoutManager.Models.Weapon>;
    var specialWeapons = ViewBag.SpecialWeapons as List<DestinyLoadoutManager.Models.Weapon>;
    var heavyWeapons = ViewBag.HeavyWeapons as List<DestinyLoadoutManager.Models.Weapon>;
}

<div class="row">
    <div class="col-lg-10 mx-auto">
        <h1>Edit Loadout: @Model.Name</h1>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5>Edit Details</h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="Edit">
                            <input type="hidden" asp-for="Id" />
                            
                            <div class="form-group mb-3">
                                <label asp-for="Name">Loadout Name</label>
                                <input asp-for="Name" class="form-control" required>
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>

                            <div class="form-group mb-3">
                                <label asp-for="Description">Description</label>
                                <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5>Current Weapons</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.LoadoutWeapons.Any())
                        {
                            @foreach (var lw in Model.LoadoutWeapons.OrderBy(x => x.Slot))
                            {
                                <div class="mb-2 p-2 bg-light rounded d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@lw.Slot.ToString():</strong> @lw.Weapon?.Name
                                        <br>
                                        <small>
                                            <span class="badge bg-light text-dark d-inline-flex align-items-center gap-1">
                                                <img src="@GetElementIcon(lw.Weapon?.Element)" class="icon-inline" alt="@lw.Weapon?.Element icon" /> @lw.Weapon?.Element
                                            </span>
                                            <span class="badge bg-secondary d-inline-flex align-items-center gap-1">
                                                <img src="@GetWeaponTypeIcon(lw.Weapon?.Type)" class="icon-inline" alt="@lw.Weapon?.Type icon" /> @lw.Weapon?.Type
                                            </span>
                                            <span class="badge bg-info">@lw.Weapon?.AmmoType</span>
                                        </small>
                                    </div>
                                    <form asp-action="RemoveWeapon" method="post" style="display:inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="loadoutWeaponId" value="@lw.Id" />
                                        <input type="hidden" name="loadoutId" value="@Model.Id" />
                                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                                    </form>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">No weapons yet. Add some below!</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <strong>Primary Slot</strong>
                    </div>
                    <div class="card-body">
                        <form asp-action="AddWeapon" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="loadoutId" value="@Model.Id" />
                            <input type="hidden" name="slotStr" value="Primary" />
                            
                            <div class="mb-2">
                                <label for="weaponSearch-primary" class="form-label">Search Weapon</label>
                                <input type="text" id="weaponSearch-primary" class="form-control" placeholder="Type weapon name..." autocomplete="off">
                                <small class="text-muted">Type to search weapons</small>
                            </div>
                            
                            <select name="weaponId" id="weaponSelect-primary" class="form-select mb-2" required>
                                <option value="">-- Select from list --</option>
                                @foreach (var weapon in primaryWeapons ?? new List<DestinyLoadoutManager.Models.Weapon>())
                                {
                                    <option value="@weapon.Id">@weapon.Name - @weapon.Element @weapon.Type @weapon.AmmoType</option>
                                }
                            </select>
                            <button type="submit" class="btn btn-sm btn-success w-100">Add to Primary</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <strong>Special Slot</strong>
                    </div>
                    <div class="card-body">
                        <form asp-action="AddWeapon" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="loadoutId" value="@Model.Id" />
                            <input type="hidden" name="slotStr" value="Special" />
                            
                            <div class="mb-2">
                                <label for="weaponSearch-special" class="form-label">Search Weapon</label>
                                <input type="text" id="weaponSearch-special" class="form-control" placeholder="Type weapon name..." autocomplete="off">
                                <small class="text-muted">Type to search weapons</small>
                            </div>
                            
                            <select name="weaponId" id="weaponSelect-special" class="form-select mb-2" required>
                                <option value="">-- Select from list --</option>
                                @foreach (var weapon in specialWeapons ?? new List<DestinyLoadoutManager.Models.Weapon>())
                                {
                                    <option value="@weapon.Id">@weapon.Name - @weapon.Element @weapon.Type @weapon.AmmoType</option>
                                }
                            </select>
                            <button type="submit" class="btn btn-sm btn-warning w-100">Add to Special</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <strong>Heavy Slot</strong>
                    </div>
                    <div class="card-body">
                        <form asp-action="AddWeapon" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="loadoutId" value="@Model.Id" />
                            <input type="hidden" name="slotStr" value="Heavy" />
                            
                            <div class="mb-2">
                                <label for="weaponSearch-heavy" class="form-label">Search Weapon</label>
                                <input type="text" id="weaponSearch-heavy" class="form-control" placeholder="Type weapon name..." autocomplete="off">
                                <small class="text-muted">Type to search weapons</small>
                            </div>
                            
                            <select name="weaponId" id="weaponSelect-heavy" class="form-select mb-2" required>
                                <option value="">-- Select from list --</option>
                                @foreach (var weapon in heavyWeapons ?? new List<DestinyLoadoutManager.Models.Weapon>())
                                {
                                    <option value="@weapon.Id">@weapon.Name - @weapon.Element @weapon.Type @weapon.AmmoType</option>
                                }
                            </select>
                            <button type="submit" class="btn btn-sm btn-danger w-100">Add to Heavy</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info">View Loadout</a>
            <a asp-action="Index" class="btn btn-secondary">Back to Loadouts</a>
        </div>
    </div>
</div>

@functions {
    private string GetElementIcon(DestinyLoadoutManager.Models.ElementType? element)
    {
        return element switch
        {
            DestinyLoadoutManager.Models.ElementType.Arc => "/icons/elements/arc.png",
            DestinyLoadoutManager.Models.ElementType.Solar => "/icons/elements/solar.png",
            DestinyLoadoutManager.Models.ElementType.Void => "/icons/elements/void.png",
            DestinyLoadoutManager.Models.ElementType.Kinetic => "/icons/elements/kinetic.png",
            _ => "/icons/elements/kinetic.png"
        };
    }

    private string GetWeaponTypeIcon(DestinyLoadoutManager.Models.WeaponType? type)
    {
        return type switch
        {
            DestinyLoadoutManager.Models.WeaponType.AutoRifle => "/icons/weapon_type/auto_rifle.png",
            DestinyLoadoutManager.Models.WeaponType.PulseRifle => "/icons/weapon_type/pulse_rifle.png",
            DestinyLoadoutManager.Models.WeaponType.ScoutRifle => "/icons/weapon_type/scout_rifle.png",
            DestinyLoadoutManager.Models.WeaponType.SniperRifle => "/icons/weapon_type/sniper_rifle.png",
            DestinyLoadoutManager.Models.WeaponType.SubmachineGun => "/icons/weapon_type/smg.png",
            DestinyLoadoutManager.Models.WeaponType.MachineGun => "/icons/weapon_type/machinegun.png",
            DestinyLoadoutManager.Models.WeaponType.FusionRifle => "/icons/weapon_type/fusion_rifle.png",
            DestinyLoadoutManager.Models.WeaponType.RocketLauncher => "/icons/weapon_type/rocket_launcher.png",
            DestinyLoadoutManager.Models.WeaponType.GrenadeGauncher => "/icons/weapon_type/grenade_launcher.png",
            DestinyLoadoutManager.Models.WeaponType.HandCannon => "/icons/weapon_type/hand_cannon.png",
            DestinyLoadoutManager.Models.WeaponType.Shotgun => "/icons/weapon_type/shotgun.png",
            DestinyLoadoutManager.Models.WeaponType.LinearFusionRifle => "/icons/weapon_type/linear_rifle.png",
            DestinyLoadoutManager.Models.WeaponType.Bow => "/icons/weapon_type/bow.png",
            DestinyLoadoutManager.Models.WeaponType.Sword => "/icons/weapon_type/sword.png",
            _ => "/icons/weapon_type/auto_rifle.png"
        };
    }
}

<script>
// Simple weapon search/filter for all 3 slots
function setupWeaponSearch(searchInputId, selectId) {
    const searchInput = document.getElementById(searchInputId);
    const select = document.getElementById(selectId);
    
    if (!searchInput || !select) return;
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        for (let option of select.options) {
            if (option.value === '') {
                option.style.display = 'block';
                continue;
            }
            
            const text = option.text.toLowerCase();
            if (text.includes(searchTerm)) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setupWeaponSearch('weaponSearch-primary', 'weaponSelect-primary');
    setupWeaponSearch('weaponSearch-special', 'weaponSelect-special');
    setupWeaponSearch('weaponSearch-heavy', 'weaponSelect-heavy');
});
</script>
