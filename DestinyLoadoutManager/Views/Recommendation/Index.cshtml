@{
    ViewData["Title"] = "Loadout Advisor";
    var surges = ViewBag.Surges as List<DestinyLoadoutManager.Models.Surge>;
    var champions = ViewBag.Champions as List<DestinyLoadoutManager.Models.Champion>;
}

<div class="row">
    <div class="col-lg-10 mx-auto">
        <h1>Loadout Advisor</h1>
        <p class="lead">Get personalized loadout recommendations based on your current activity.</p>

        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5>Select Activity Conditions</h5>
            </div>
            <div class="card-body">
                <form id="recommendationForm" method="post" asp-action="GetRecommendations">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="surgeName" class="form-label">Active Surge</label>
                            <select class="form-select" id="surgeName" name="surgeName" required>
                                <option value="">-- Select a Surge --</option>
                                @if (surges != null)
                                {
                                    @foreach (var surge in surges)
                                    {
                                        <option value="@surge.Name">@surge.Name (@surge.ElementType)</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Active Champions</label>
                            <div>
                                @if (champions != null)
                                {
                                    @foreach (var champion in champions)
                                    {
                                        <div class="form-check d-flex align-items-center gap-2">
                                            <input class="form-check-input" type="checkbox" name="selectedChampionIds" value="@champion.Id" id="champion_@champion.Id">
                                            <label class="form-check-label d-flex align-items-center gap-2" for="champion_@champion.Id">
                                                <img src="@GetChampionIcon(champion.Name)" class="icon-inline" alt="@champion.Name icon" />
                                                <span>@champion.Name - @champion.Description</span>
                                            </label>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg mt-3">Get Recommendations</button>
                </form>
            </div>
        </div>

        <div id="resultsContainer"></div>
    </div>
</div>

<script>
document.getElementById('recommendationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const surgeName = formData.get('surgeName');
    const selectedChampionIds = formData.getAll('selectedChampionIds');

    if (!surgeName) {
        alert('Please select a surge');
        return;
    }

    try {
        const response = await fetch('@Url.Action("GetRecommendations")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                'surgeName': surgeName,
                'selectedChampionIds': selectedChampionIds
            })
        });

        if (response.ok) {
            const html = await response.text();
            document.getElementById('resultsContainer').innerHTML = html;
        } else {
            document.getElementById('resultsContainer').innerHTML = '<div class="alert alert-danger">Error fetching recommendations</div>';
        }
    } catch (error) {
        document.getElementById('resultsContainer').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    }
});
</script>

@functions {
    private string GetChampionIcon(string name)
    {
        return name switch
        {
            "Anti-Barrier" => "/icons/champions/barrier.png",
            "Overload" => "/icons/champions/overload.png",
            "Unstoppable" => "/icons/champions/unstoppable.png",
            _ => "/icons/champions/barrier.png"
        };
    }
}
